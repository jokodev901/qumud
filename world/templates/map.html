{% extends base_template %}

{% block content %}
<div hx-get="{% url 'map' %}" hx-trigger="every 1s" hx-vals='{"trigger": "update"}' hx-swap="none"></div>
<div class="container">
    <div class="row g-3">
        <div class="col-lg-8 col-md-7">
            <div id="event-card" class="card mb-3" hx-target="#event-card-body">
                <div class="card-header d-flex justify-content-between">
                    <span>Event</span>
                </div>
                <div id="event-card-body" class="card-body">
                    <div id="event-card-swap">
                        <div class="event-graphic position-relative">
                            <span class="text-muted italic">Graphic Placeholder</span>
                            {% for svg in enemy_svgs %}
                            {{ svg.svg|safe }}
                            {% endfor %}
                        </div>
                        <div class="scroll-window mb-3" style="height: 250px; font-size: 0.85rem;">
                            {% for svg in enemy_svgs %}
                            <div class="text-success">You encountered a {{ svg.name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-sm btn-dark-outline px-4">Flee</button>
                        <button class="btn btn-sm btn-dark-outline px-4">Loot Item</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-5">
            <div id="status-card" class="card mb-3" hx-target="#status-card-body">
                <div class="card-header">Status</div>
                <div id="status-card-body" class="card-body">
                    <div id="status-card-swap">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold">{{ character.name }}</span>
                            <span class="badge bg-secondary">Lvl {{  character.level }}</span>
                        </div>
                        <div class="progress mb-2 position-relative bg-black border border-white" style="height: 20px;">
                            <div class="progress-bar bg-danger"
                                 role="progressbar"
                                 style="width: {{ character_health_perc }}%;"
                                 aria-valuenow="{{ character.health }}"
                                 aria-valuemin="0"
                                 aria-valuemax="{{ character.max_health }}"></div>
                            <span class="justify-content-center d-flex position-absolute w-100 text-white text-shadow">
                                {{ character.health }} / {{ character.max_health }} HP</span>
                        </div>
                        <div class="progress mb-2 position-relative bg-black border border-white" style="height: 20px;">
                            <div class="progress-bar bg-info"
                                 role="progressbar"
                                 style="width: 100%;"
                                 aria-valuenow="100"
                                 aria-valuemin="0"
                                 aria-valuemax="100"></div>
                            <span class="justify-content-center d-flex position-absolute w-100 text-white text-shadow">
                                100 / 100 MP</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="travel-card" class="card" hx-target="#travel-card-body">
                <div class="card-header">Travel</div>
                    <div id="travel-card-body" class="card-body">
                    {% include 'partials/travel.html' %}
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-lg-8 col-md-7">
            <div id="region-chat-card" class="card">
                <div class="card-header">Region Chat</div>
                <div id="region-chat-card-body" class="card-body p-0">
                    <div class="p-2 border-bottom border-secondary">
                        <form id="region-chat-form" style="display: contents;"
                              autocomplete="off"
                              hx-swap="none"
                              hx-on::after-request="this.reset()">
                            <div class="input-group">
                                <input type="text"
                                       class="form-control form-control-sm bg-black text-white border-secondary"
                                       style="--bs-secondary-color: #555;"
                                       name="region-chat-msg"
                                       placeholder="Type a message...">
                                <button class="btn btn-sm btn-dark-outline"
                                        type="submit"
                                        hx-post='{% url "region_chat" %}'>Send</button>
                            </div>
                        </form>
                    </div>
                    <div class="row g-0">
                        <div class="col-9">
                            <div class="scroll-window" style="border-radius: 0 0 0 4px;">
                                <div id="region-chat-swap">
                                {% for message in messages %}
                                    <div><span class="text-success">{{ message.user.alias }}:</span> {{ message.message }}</div>
                                {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="player-list">
                                <div class="px-2 pt-2 pb-1 small border-bottom border-secondary mb-1">Online Players</div>
                                <div id="player-list-swap" class="list-group list-group-flush">
                                    {% for player in region_players %}
                                        <div class="list-group-item">{{ player.alias }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function moveSprites() {
        const sprites = document.querySelectorAll('.sprite');

        sprites.forEach((sprite) => {
            // Only move if the sprite is NOT defeated
            if (!sprite.classList.contains('defeat-animate')) {
                const randomTop = Math.floor(Math.random() * 60) + 20;
                const randomLeft = Math.floor(Math.random() * 60) + 20;

                sprite.style.top = `${randomTop}%`;
                sprite.style.left = `${randomLeft}%`;
            }
        });
    }

    // Start the movement
    const movementInterval = setInterval(moveSprites, 2000);

    // TEST 1: Defeat the first sprite after 10 seconds
    setTimeout(() => {
        const sprites = document.querySelectorAll('.sprite');
        if (sprites[0]) {
            console.log("Defeating Sprite 1...");
            sprites[0].classList.add('defeat-animate');
        }
    }, 10000);
</script>
{% endblock %}