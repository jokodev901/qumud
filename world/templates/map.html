{% extends base_template %}

{% block content %}
<div hx-get="{% url 'map' %}" hx-trigger="every 1s" hx-vals='{"trigger": "update"}' hx-swap="none"></div>
<div class="container">
    <div class="row g-3">
        <div class="col-lg-8 col-md-7">
            <div id="event-card" class="card mb-3" hx-target="#event-card-body">
                <div class="card-header d-flex justify-content-between">
                    <span>Event</span>
                </div>
                <div id="event-card-body" class="card-body">
                    <div class="event-graphic position-relative">
                        <span class="text-muted italic">Graphic Placeholder</span>
                        <svg class="position-absolute sprite" style="top: 50%; left: 50%; transform: translate(-50%, -50%); width: 3rem; height: 3rem; z-index: 1;"
                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100"> <g><animateTransform attributeName="transform" type="translate" values="0,0; 1,1; -1,0; -2,1; 0,0" dur="0.14s" repeatCount="indefinite" /> <path d="M 86.0 50.0 L 62.1 50.0 L 62.1 58.8 L 63.0 58.8 L 63.0 89.9 L 35.8 89.9 L 35.8 93.7 L 46.0 93.7 L 46.0 52.9 L 46.0 50.0 L 42.0 50.0 L 46.0 50.0 L 46.0 47.1 L 46.0 6.3 L 35.8 6.3 L 63.0 6.3 L 63.0 10.1 L 62.1 10.1 L 62.1 41.2 L 62.1 50.0 L 86.0 50.0 Z" fill="white" /> <rect x="42.0" y="47.5" width="6" height="5" fill="black" stroke="white" stroke-width="2" rx="2" /><rect x="52.0" y="47.5" width="6" height="5" fill="black" stroke="white" stroke-width="2"rx="2" /> </g> </svg>
                        <svg class="position-absolute sprite" style="top: 50%; left: 10%; transform: translate(-50%, -50%); width: 3rem; height: 3rem;z-index: 1;"
                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100"> <g><animateTransform attributeName="transform" type="translate" values="0,-5; 0,5; 0,-5" dur="7.7s" repeatCount="indefinite" calcMode="spline" keySplines="0.45 0 0.55 1; 0.45 0 0.55 1" /> <path d="M 55.0 50.0 Q 59.0 54.3, 56.9 58.6 Q 54.3 69.0, 46.0 67.5 Q 39.1 63.7, 38.3 55.6 Q 35.0 50.0, 38.3 44.4 Q 43.8 42.2, 48.9 45.1 Q 56.5 21.7, 71.8 22.6 Q 73.4 38.7, 55.0 50.0 Z" fill="white" /> <rect x="42.0" y="48.0" width="6" height="4" fill="black" stroke="white" stroke-width="2" rx="2" /><rect x="52.0" y="48.0" width="6" height="4" fill="black" stroke="white" stroke-width="2"rx="2" /> </g> </svg>
                    </div>

                    <div class="scroll-window mb-3" style="height: 250px; font-size: 0.85rem;">
                        <div class="text-success">You encountered a Skeleton Warrior!</div>
                        <div class="text-light">Player hit Skeleton for 2 damage!</div>
                        <div class="text-danger">Skeleton hits Player for 1 damage!</div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-sm btn-dark-outline px-4">Flee</button>
                        <button class="btn btn-sm btn-dark-outline px-4">Loot Item</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-5">
            <div id="status-card" class="card mb-3" hx-target="#status-card-body">
                <div class="card-header">Status</div>
                <div id="status-card-body" class="card-body">
                    <div id="status-card-swap">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold">{{ character.name }}</span>
                            <span class="badge bg-secondary">Lvl {{  character.level }}</span>
                        </div>
                        <div class="progress mb-2 position-relative bg-black border border-white" style="height: 20px;">
                            <div class="progress-bar bg-danger"
                                 role="progressbar"
                                 style="width: {{ character_health_perc }}%;"
                                 aria-valuenow="{{ character.health }}"
                                 aria-valuemin="0"
                                 aria-valuemax="{{ character.max_health }}"></div>
                            <span class="justify-content-center d-flex position-absolute w-100 text-white text-shadow">
                                {{ character.health }} / {{ character.max_health }} HP</span>
                        </div>
                        <div class="progress mb-2 position-relative bg-black border border-white" style="height: 20px;">
                            <div class="progress-bar bg-info"
                                 role="progressbar"
                                 style="width: 100%;"
                                 aria-valuenow="100"
                                 aria-valuemin="0"
                                 aria-valuemax="100"></div>
                            <span class="justify-content-center d-flex position-absolute w-100 text-white text-shadow">
                                100 / 100 MP</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="travel-card" class="card" hx-target="#travel-card-body">
                <div class="card-header">Travel</div>
                    <div id="travel-card-body" class="card-body">
                    {% include 'partials/travel.html' %}
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-lg-8 col-md-7">
            <div id="region-chat-card" class="card">
                <div class="card-header">Region Chat</div>
                <div id="region-chat-card-body" class="card-body p-0">
                    <div class="p-2 border-bottom border-secondary">
                        <form id="region-chat-form" style="display: contents;"
                              autocomplete="off"
                              hx-swap="none"
                              hx-on::after-request="this.reset()">
                            <div class="input-group">
                                <input type="text"
                                       class="form-control form-control-sm bg-black text-white border-secondary"
                                       style="--bs-secondary-color: #555;"
                                       name="region-chat-msg"
                                       placeholder="Type a message...">
                                <button class="btn btn-sm btn-dark-outline"
                                        type="submit"
                                        hx-post='{% url "region_chat" %}'>Send</button>
                            </div>
                        </form>
                    </div>
                    <div class="row g-0">
                        <div class="col-9">
                            <div class="scroll-window" style="border-radius: 0 0 0 4px;">
                                <div id="region-chat-swap">
                                {% for message in messages %}
                                    <div><span class="text-success">{{ message.user.alias }}:</span> {{ message.message }}</div>
                                {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="player-list">
                                <div class="px-2 pt-2 pb-1 small border-bottom border-secondary mb-1">Online Players</div>
                                <div id="player-list-swap" class="list-group list-group-flush">
                                    {% for player in region_players %}
                                        <div class="list-group-item">{{ player.alias }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function moveSprites() {
        const sprites = document.querySelectorAll('.sprite');

        sprites.forEach((sprite) => {
            // Only move if the sprite is NOT defeated
            if (!sprite.classList.contains('defeat-animate')) {
                const randomTop = Math.floor(Math.random() * 60) + 20;
                const randomLeft = Math.floor(Math.random() * 60) + 20;

                sprite.style.top = `${randomTop}%`;
                sprite.style.left = `${randomLeft}%`;
            }
        });
    }

    // Start the movement
    const movementInterval = setInterval(moveSprites, 2000);

    // TEST 1: Defeat the first sprite after 10 seconds
    setTimeout(() => {
        const sprites = document.querySelectorAll('.sprite');
        if (sprites[0]) {
            console.log("Defeating Sprite 1...");
            sprites[0].classList.add('defeat-animate');
        }
    }, 10000);
</script>
{% endblock %}